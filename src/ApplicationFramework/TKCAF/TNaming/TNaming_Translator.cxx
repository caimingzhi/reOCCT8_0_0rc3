#include <BRep_TEdge.hpp>
#include <BRep_TFace.hpp>
#include <BRep_TVertex.hpp>
#include <BRepTools.hpp>
#include <TCollection_AsciiString.hpp>
#include <TNaming_CopyShape.hpp>
#include <TNaming_Translator.hpp>
#include <TopLoc_Datum3D.hpp>
#include <TopoDS_Shape.hpp>
#include <TopoDS_TCompound.hpp>
#include <TopoDS_TCompSolid.hpp>
#include <TopoDS_TShape.hpp>
#include <TopoDS_TShell.hpp>
#include <TopoDS_TSolid.hpp>
#include <TopoDS_TWire.hpp>
#include <TopTools_ShapeMapHasher.hpp>
#include <NCollection_DataMap.hpp>

TNaming_Translator::TNaming_Translator()
    : myIsDone(false)
{
  myDataMapOfResults.Clear();
}

void TNaming_Translator::Add(const TopoDS_Shape& aShape)
{
  TopoDS_Shape aResult;
  myDataMapOfResults.Bind(aShape, aResult);
}

bool TNaming_Translator::IsDone() const
{
  return myIsDone;
}

const NCollection_DataMap<TopoDS_Shape, TopoDS_Shape, TopTools_ShapeMapHasher>& TNaming_Translator::
  Copied() const
{
  return myDataMapOfResults;
}

const TopoDS_Shape TNaming_Translator::Copied(const TopoDS_Shape& aShape) const
{
  TopoDS_Shape aResult;
  if (myDataMapOfResults.IsBound(aShape))
    aResult = myDataMapOfResults.Find(aShape);
  return aResult;
}

void TNaming_Translator::Perform()
{
  TopoDS_Shape                                                                       Result;
  NCollection_DataMap<TopoDS_Shape, TopoDS_Shape, TopTools_ShapeMapHasher>::Iterator itm(
    myDataMapOfResults);
  for (; itm.More(); itm.Next())
  {
    TNaming_CopyShape::CopyTool(itm.Key(), myMap, Result);
    if (!Result.IsNull())
      myDataMapOfResults(itm.Key()) = Result;
    Result.Nullify();
  }
  if (myDataMapOfResults.Extent())
    myIsDone = true;
}

void TNaming_Translator::DumpMap(const bool isWrite) const
{
  TCollection_AsciiString name("Map");
  TCollection_AsciiString keyname;
  TCollection_AsciiString itemname;
  keyname  = name.Cat("_Key");
  itemname = name.Cat("_Item");

  if (!myMap.Extent())
    return;
  else
    std::cout << "TNaming_Translator:: IndexedDataMap Extent = " << myMap.Extent() << std::endl;

  for (int i = 1; i <= myMap.Extent(); i++)
  {
    std::cout << "TNaming_Translator::DumpMap:  Index = " << i
              << " Type = " << (myMap.FindKey(i))->DynamicType() << std::endl;
    occ::handle<Standard_Type> T = (myMap.FindKey(i))->DynamicType();
    if ((T == STANDARD_TYPE(BRep_TVertex)) || (T == STANDARD_TYPE(BRep_TEdge))
        || T == STANDARD_TYPE(BRep_TFace) || T == STANDARD_TYPE(TopoDS_TWire)
        || T == STANDARD_TYPE(TopoDS_TShell) || T == STANDARD_TYPE(TopoDS_TSolid)
        || T == STANDARD_TYPE(TopoDS_TCompSolid) || T == STANDARD_TYPE(TopoDS_TCompound))
    {
      if (isWrite)
      {
        occ::handle<TopoDS_TShape> key(occ::down_cast<TopoDS_TShape>(myMap.FindKey(i)));
        occ::handle<TopoDS_TShape> item(occ::down_cast<TopoDS_TShape>(myMap.FindFromIndex(i)));
        TopoDS_Shape               S1;
        S1.TShape(key);
        TopoDS_Shape S2;
        S2.TShape(item);
        BRepTools::Write(S1, keyname.Cat(i).ToCString());
        BRepTools::Write(S2, itemname.Cat(i).ToCString());
      }
    }
    else if ((myMap.FindKey(i))->DynamicType() == STANDARD_TYPE(TopLoc_Datum3D))
    {
      if (isWrite)
      {
        const occ::handle<TopLoc_Datum3D> key = occ::down_cast<TopLoc_Datum3D>(myMap.FindKey(i));
        const occ::handle<TopLoc_Datum3D> Item =
          occ::down_cast<TopLoc_Datum3D>(myMap.FindFromIndex(i));
        std::cout << "TNaming_Translator::DumpMap: Location_Key_name  = "
                  << keyname.Cat(i).ToCString() << std::endl;
        key->ShallowDump(std::cout);
        std::cout << "TNaming_Translator::DumpMap: Location_Item_name = "
                  << itemname.Cat(i).ToCString() << std::endl;
        Item->ShallowDump(std::cout);
      }
    }
    else
    {
      std::cout << "TNaming_Translator::DumpMap: Unexpected Type >> Idex = " << i
                << " Type = " << (myMap.FindKey(i))->DynamicType() << std::endl;
      continue;
    }
  }
}
